<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title>Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector? - Marcin Skalski's Blog</title><meta name=Description content="Marcin Skalsi's personal blog about JVM internals, performance and other Java related stuff"><meta property="og:title" content="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?">
<meta property="og:description" content="Recently I stumbled upon an interesting issue in one of our services. When going through our Grafana dashboards I have discovered that time spent in GC for this service is abnormally high. Immediately I started investigating this issue. The investigation was pretty quick and an issue was rather simple but it gave us a significant performance boost. So I decided to share it with you and shed some light on how adaptive heap sizing in jvm works and how it can sometimes be a problem.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mskalski.dev/xms_good_practice/"><meta property="og:image" content="https://mskalski.dev/logo.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-05-27T12:26:09+02:00">
<meta property="article:modified_time" content="2023-02-21T07:05:40+01:00"><meta property="og:site_name" content="My cool site">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://mskalski.dev/logo.jpg">
<meta name=twitter:title content="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?">
<meta name=twitter:description content="Recently I stumbled upon an interesting issue in one of our services. When going through our Grafana dashboards I have discovered that time spent in GC for this service is abnormally high. Immediately I started investigating this issue. The investigation was pretty quick and an issue was rather simple but it gave us a significant performance boost. So I decided to share it with you and shed some light on how adaptive heap sizing in jvm works and how it can sometimes be a problem.">
<meta name=application-name content="Marcin Skalski's Blog">
<meta name=apple-mobile-web-app-title content="Marcin Skalski's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mskalski.dev/xms_good_practice/><link rel=prev href=https://mskalski.dev/timeouts/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mskalski.dev\/xms_good_practice\/"},"image":["https:\/\/mskalski.dev\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":1545,"url":"https:\/\/mskalski.dev\/xms_good_practice\/","datePublished":"2020-05-27T12:26:09+02:00","dateModified":"2023-02-21T07:05:40+01:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Marcin Skalski","logo":"https:\/\/mskalski.dev\/images\/avatar.png"},"author":{"@type":"Person","name":"Marcin Skalski"},"description":""}</script></head>
<body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Marcin Skalski's Blog">Marcin Skalski's Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/public_speaking/> Public Speaking </a><a class=menu-item href=/about/> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Marcin Skalski's Blog">Marcin Skalski's Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/public_speaking/ title>Public Speaking</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</header><div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div><main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Marcin Skalski</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2020-05-27>2020-05-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1545 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;8 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#service-overview>Service overview</a></li>
<li><a href=#looking-through-grafana-dashboards>Looking through Grafana dashboards</a></li>
<li><a href=#adding--xms-along--xmx>Adding -Xms along -Xmx</a></li>
<li><a href=#why-this-helped-and-why-previously-heap-was-only-40mb>Why this helped and why previously heap was only 40mb?</a></li>
<li><a href=#looking-at-gc-logs-and-finding-the-right-values-for-eden-and-tenuring-space>Looking at GC logs and finding the right values for Eden and tenuring space</a></li>
<li><a href=#summary>Summary</a></li>
</ul>
</li>
<li><a href=#references>References</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>Recently I stumbled upon an interesting issue in one of our services. When going through our Grafana dashboards I have discovered that
time spent in GC for this service is abnormally high. Immediately I started investigating this issue. The investigation was pretty quick
and an issue was rather simple but it gave us a significant performance boost. So I decided to share it with you and shed some
light on how adaptive heap sizing in jvm works and how it can sometimes be a problem.</p>
<h3 id=service-overview>Service overview</h3>
<p>First, I want to tell you a little more about the service I was working with. In my opinion, it is the most complicated service
our team created. Mostly because it utilizes 3 databases (<code>MongoDb</code>(aggregated statistics for single notification),
<code>Cassandra</code> (event store) and <code>ElasticSearch</code> (notifications full text search)) it internally uses <code>Kafka</code>
(queue before DBs for reliability purposes) and was written in <code>Spring's Reactor</code>.
The business purpose of this service is to track all notifications sent from our infrastructure. It aggregates few different events:</p>
<ul>
<li>When the notification was sent</li>
<li>If the notification was failed to send</li>
<li>When the user opened a notification</li>
<li>When the user clicked in any of the links inside of the notification</li>
</ul>
<p>During the day we are observing traffic around <code>few thousands rps (requests per second)</code>. Here is an example of traffic from the most common day:</p>
<p>And normal p99 of responses time form tracker service:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/typowy_p99.png data-srcset="/images/2020/05/typowy_p99.png, /images/2020/05/typowy_p99.png 1.5x, /images/2020/05/typowy_p99.png 2x" data-sizes=auto alt=/images/2020/05/typowy_p99.png title=/images/2020/05/typowy_p99.png></p>
<p>As you can see it is disturbingly high.</p>
<p>The tracking service is running at 10 instances in a production environment. Every instance has <strong>3GB</strong> of memory committed as uses <strong>2</strong> processor cores.
In total it gives us <strong>30GB</strong> of memory and <strong>20</strong> processor cores. Which I think is a lot for the work it has to do.</p>
<h3 id=looking-through-grafana-dashboards>Looking through Grafana dashboards</h3>
<p>I have discovered that most tracking service instances are spending 30 seconds out of minute in GC. Here is how it looks like on charts:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/typowy_czas_w_gc.png data-srcset="/images/2020/05/typowy_czas_w_gc.png, /images/2020/05/typowy_czas_w_gc.png 1.5x, /images/2020/05/typowy_czas_w_gc.png 2x" data-sizes=auto alt=/images/2020/05/typowy_czas_w_gc.png title=/images/2020/05/typowy_czas_w_gc.png></p>
<p>Also, a number of GC collections were really high, almost 15k collection per 10 minutes:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/typowa_ilosc_kolekcji.png data-srcset="/images/2020/05/typowa_ilosc_kolekcji.png, /images/2020/05/typowa_ilosc_kolekcji.png 1.5x, /images/2020/05/typowa_ilosc_kolekcji.png 2x" data-sizes=auto alt=/images/2020/05/typowa_ilosc_kolekcji.png title=/images/2020/05/typowa_ilosc_kolekcji.png></p>
<p>I began investigation. I have downloaded gc.log for one instance. Using <code>JClarity's Censum</code> I have discovered that allocation rate was
around <strong>1GB</strong> and <strong>1.8GB</strong> in peaks, which was pretty high.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/allocation_rates.png data-srcset="/images/2020/05/allocation_rates.png, /images/2020/05/allocation_rates.png 1.5x, /images/2020/05/allocation_rates.png 2x" data-sizes=auto alt=/images/2020/05/allocation_rates.png title=/images/2020/05/allocation_rates.png></p>
<p>Moreover, there was huge percent of premature promotions, to be exact <strong>52%</strong>. I have assumed that this is because of this high allocation rates.</p>
<p>In the next step I have created and downloaded heap dump for this instance, to check contents of the heap. It was quite a surprise when I discovered
that it&rsquo;s size was only <strong>42MB</strong>. With this allocation rate, there was no surprise that <code>JVM</code> was spending thirty seconds out of
minute in GC. The percent of premature promotions was that high because heap was only 42MB in size and object allocation rate was more than 1GB.
I cannot believe we deliberately set that small heaps, so I have checked the jvm properties from our configuration, and the only
heap size property that was set was <code>-Xmx2G</code>. My first reflex was to add <code>-Xms</code> property which I did right away.</p>
<h3 id=adding--xms-along--xmx>Adding -Xms along -Xmx</h3>
<p>I have set <strong>-Xms1g</strong> and <strong>-Xmx1g</strong> and here are the results of this change:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/xmx_czas_w_gc.png data-srcset="/images/2020/05/xmx_czas_w_gc.png, /images/2020/05/xmx_czas_w_gc.png 1.5x, /images/2020/05/xmx_czas_w_gc.png 2x" data-sizes=auto alt=/images/2020/05/xmx_czas_w_gc.png title=/images/2020/05/xmx_czas_w_gc.png></p>
<p>and</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/xmx_kolekcje.png data-srcset="/images/2020/05/xmx_kolekcje.png, /images/2020/05/xmx_kolekcje.png 1.5x, /images/2020/05/xmx_kolekcje.png 2x" data-sizes=auto alt=/images/2020/05/xmx_kolekcje.png title=/images/2020/05/xmx_kolekcje.png></p>
<p>As we can see time spent in a GC was reduced significantly. Moreover, thanks to that response times from our service was also reduced</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/xmx_p99_event.png data-srcset="/images/2020/05/xmx_p99_event.png, /images/2020/05/xmx_p99_event.png 1.5x, /images/2020/05/xmx_p99_event.png 2x" data-sizes=auto alt=/images/2020/05/xmx_p99_event.png title=/images/2020/05/xmx_p99_event.png></p>
<h3 id=why-this-helped-and-why-previously-heap-was-only-40mb>Why this helped and why previously heap was only 40mb?</h3>
<p>When we don&rsquo;t set <code>-Xms</code> flag explicitly the initial heap size will be set to 1/64 of all available memory.
Which in our case was around 31MB. We can control how fast JVM is resizing it&rsquo;s heap by setting flags: <code>-XX:MinHeapFreeRatio</code>
and <code>-XX:MaxHeapFreeRatio</code> which defaults are 40% and 70%. This means that JVM will enlarge its heap after full gc when
percent of free space is less than 40. On the other, hand heap size will shrink after full GC if there is more than 70% space free.
JVM is less eager to reduce heap size because it is more complicated operation and will take more time which will significantly
affect application performance. This is default resizing policy and because objects that were allocated by our application was
dying young and most of them were removed after full GC we could never reach this <code>MinHeapFreeRatio</code> threshold. This is fragment
of our GC log:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>463</span><span class=o>.</span><span class=na>462</span><span class=o>:</span> <span class=o>[</span><span class=n>GC</span> <span class=o>(</span><span class=n>Allocation</span> <span class=n>Failure</span><span class=o>)</span> <span class=n>463</span><span class=o>.</span><span class=na>462</span><span class=o>:</span> <span class=o>[</span><span class=n>ParNew</span>
    <span class=n>Desired</span> <span class=n>survivor</span> <span class=n>size</span> <span class=n>425984</span> <span class=n>bytes</span><span class=o>,</span> <span class=k>new</span> <span class=n>threshold</span> <span class=nf>6</span> <span class=o>(</span><span class=n>max</span> <span class=n>6</span><span class=o>)</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>1</span><span class=o>:</span>     <span class=n>386048</span> <span class=n>bytes</span><span class=o>,</span>     <span class=n>386048</span> <span class=n>total</span>
    <span class=o>:</span> <span class=n>7997K</span><span class=o>-&gt;</span><span class=n>606K</span><span class=o>(</span><span class=n>8000K</span><span class=o>),</span> <span class=n>0</span><span class=o>.</span><span class=na>0055859</span> <span class=n>secs</span><span class=o>]</span> <span class=n>80902K</span><span class=o>-&gt;</span><span class=n>73901K</span><span class=o>(</span><span class=n>178220K</span><span class=o>)</span> <span class=n>icms_dc</span><span class=o>=</span><span class=n>13</span> <span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0056746</span> <span class=n>secs</span><span class=o>]</span> 
    <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>01</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>00</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>01</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>463</span><span class=o>.</span><span class=na>473</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>abortable</span><span class=o>-</span><span class=n>preclean</span><span class=o>:</span> <span class=n>0</span><span class=o>.</span><span class=na>005</span><span class=o>/</span><span class=n>0</span><span class=o>.</span><span class=na>043</span> <span class=n>secs</span><span class=o>]</span> 
    <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>06</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>01</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>04</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>463</span><span class=o>.</span><span class=na>473</span><span class=o>:</span> <span class=o>[</span><span class=n>GC</span> <span class=o>(</span><span class=n>CMS</span> <span class=n>Final</span> <span class=n>Remark</span><span class=o>)</span> <span class=o>[</span><span class=n>YG</span> <span class=n>occupancy</span><span class=o>:</span> <span class=n>3754</span> <span class=nf>K</span> <span class=o>(</span><span class=n>8000</span> <span class=n>K</span><span class=o>)]</span>
<span class=n>463</span><span class=o>.</span><span class=na>473</span><span class=o>:</span> <span class=o>[</span><span class=n>Rescan</span> <span class=o>(</span><span class=n>parallel</span><span class=o>)</span> <span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0040316</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>463</span><span class=o>.</span><span class=na>477</span><span class=o>:</span> <span class=o>[</span><span class=n>weak</span> <span class=n>refs</span> <span class=n>processing</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0000878</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>463</span><span class=o>.</span><span class=na>477</span><span class=o>:</span> <span class=o>[</span><span class=kd>class</span> <span class=nc>unloading</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0269731</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>463</span><span class=o>.</span><span class=na>504</span><span class=o>:</span> <span class=o>[</span><span class=n>scrub</span> <span class=n>symbol</span> <span class=n>table</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0243151</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>463</span><span class=o>.</span><span class=na>529</span><span class=o>:</span> <span class=o>[</span><span class=n>scrub</span> <span class=n>string</span> <span class=n>table</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0014955</span> <span class=n>secs</span><span class=o>]</span>
    <span class=o>[</span><span class=n>1</span> <span class=n>CMS</span><span class=o>-</span><span class=n>remark</span><span class=o>:</span> <span class=n>73295K</span><span class=o>(</span><span class=n>170220K</span><span class=o>)]</span> <span class=n>77049K</span><span class=o>(</span><span class=n>178220K</span><span class=o>),</span> <span class=n>0</span><span class=o>.</span><span class=na>0570683</span> <span class=n>secs</span><span class=o>]</span> 
    <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>06</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>00</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>06</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>463</span><span class=o>.</span><span class=na>531</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>sweep</span><span class=o>-</span><span class=n>start</span><span class=o>]</span>
</code></pre></td></tr></table>
</div>
</div><p>In line 14 we can see that live objects were occupying <strong>77049KB</strong> out of <strong>178220KB</strong> available memory on the heap. Which means there
was almost 60 percent of free space. And this was rather a standard situation after each full GC.</p>
<p>This problem occurred because we were using <code>Concurrent Mark Sweep</code> collector. <strong>CMS does not</strong> support adaptive sizing policy,
which is default for <code>Parallel</code> and <code>G1</code> collectors. With adaptive sizing there are three criteria taken into account when
deciding if the heap should be resized:</p>
<ol>
<li><strong>Desired maximum GC pause goal</strong> - if the GC pause time is greater than the pause time goal then reduce the sizes of the
generations to better attain the goal.</li>
<li><strong>Desired application throughput goal</strong> - if the pause time goal is being met then consider the application&rsquo;s throughput goal.
If the application&rsquo;s throughput goal is not being met, then increase the sizes of the generations to better attain the goal.</li>
<li><strong>Minimum footprint</strong> - if both the pause time goal and the throughput goal are being met, then the size of the
generations are decreased to reduce footprint.</li>
</ol>
<p>However we were using CMS GC so we cannot rely on adaptive sizing. But we can compute how large heap we need.</p>
<h3 id=looking-at-gc-logs-and-finding-the-right-values-for-eden-and-tenuring-space>Looking at GC logs and finding the right values for Eden and tenuring space</h3>
<p>Right now we have defined our heap size and to be <strong>1GB</strong>. But we have not specified the size of generations. Due to that CMS is
creating really small Eden there would be still a lot of collections in young generation. If we look again
at allocation rates we can see that most of the time we are allocating around 800mb per second. It would be nice not to have
more than one collection per second. Our service is using around 200-300mb of memory for Spring and configuration and rest
of the objects have really short lifespan. So we can set young generation size to <strong>600mb</strong> an old size to <strong>400mb</strong>. Here
are the results of this change:</p>
<p>Typical young collection time (0.01 sec):</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>5968</span><span class=o>.</span><span class=na>202</span><span class=o>:</span> <span class=o>[</span><span class=n>GC</span> <span class=o>(</span><span class=n>Allocation</span> <span class=n>Failure</span><span class=o>)</span> <span class=n>5968</span><span class=o>.</span><span class=na>202</span><span class=o>:</span> <span class=o>[</span><span class=n>ParNew</span>
    <span class=n>Desired</span> <span class=n>survivor</span> <span class=n>size</span> <span class=n>31457280</span> <span class=n>bytes</span><span class=o>,</span> <span class=k>new</span> <span class=n>threshold</span> <span class=nf>6</span> <span class=o>(</span><span class=n>max</span> <span class=n>6</span><span class=o>)</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>1</span><span class=o>:</span>    <span class=n>1232984</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>1232984</span> <span class=n>total</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>2</span><span class=o>:</span>    <span class=n>2318608</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>3551592</span> <span class=n>total</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>3</span><span class=o>:</span>     <span class=n>302888</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>3854480</span> <span class=n>total</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>4</span><span class=o>:</span>     <span class=n>938800</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>4793280</span> <span class=n>total</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>5</span><span class=o>:</span>      <span class=n>69456</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>4862736</span> <span class=n>total</span>
    <span class=o>-</span> <span class=n>age</span>   <span class=n>6</span><span class=o>:</span>      <span class=n>56680</span> <span class=n>bytes</span><span class=o>,</span>    <span class=n>4919416</span> <span class=n>total</span>
    <span class=o>:</span> <span class=n>498270K</span><span class=o>-&gt;</span><span class=n>5506K</span><span class=o>(</span><span class=n>552960K</span><span class=o>),</span> <span class=n>0</span><span class=o>.</span><span class=na>0078395</span> <span class=n>secs</span><span class=o>]</span> <span class=n>615145K</span><span class=o>-&gt;</span><span class=n>123035K</span><span class=o>(</span><span class=n>987136K</span><span class=o>)</span> <span class=n>icms_dc</span><span class=o>=</span><span class=n>0</span> <span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0079445</span> <span class=n>secs</span><span class=o>]</span> 
    <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>02</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>00</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>01</span> <span class=n>secs</span><span class=o>]</span> 
</code></pre></td></tr></table>
</div>
</div><p>Typical old collection pause time(0.21sec):</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>27</span><span class=o>.</span><span class=na>719</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>abortable</span><span class=o>-</span><span class=n>preclean</span><span class=o>:</span> <span class=n>0</span><span class=o>.</span><span class=na>849</span><span class=o>/</span><span class=n>4</span><span class=o>.</span><span class=na>488</span> <span class=n>secs</span><span class=o>]</span> <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>11</span><span class=o>.</span><span class=na>33</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>83</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>4</span><span class=o>.</span><span class=na>49</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>27</span><span class=o>.</span><span class=na>720</span><span class=o>:</span> <span class=o>[</span><span class=n>GC</span> <span class=o>(</span><span class=n>CMS</span> <span class=n>Final</span> <span class=n>Remark</span><span class=o>)</span> <span class=o>[</span><span class=n>YG</span> <span class=n>occupancy</span><span class=o>:</span> <span class=n>256247</span> <span class=nf>K</span> <span class=o>(</span><span class=n>552960</span> <span class=n>K</span><span class=o>)]</span>
<span class=n>27</span><span class=o>.</span><span class=na>720</span><span class=o>:</span> <span class=o>[</span><span class=n>Rescan</span> <span class=o>(</span><span class=n>parallel</span><span class=o>)</span> <span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>1079998</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>828</span><span class=o>:</span> <span class=o>[</span><span class=n>weak</span> <span class=n>refs</span> <span class=n>processing</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0002720</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>828</span><span class=o>:</span> <span class=o>[</span><span class=kd>class</span> <span class=nc>unloading</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0671273</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>895</span><span class=o>:</span> <span class=o>[</span><span class=n>scrub</span> <span class=n>symbol</span> <span class=n>table</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0297383</span> <span class=n>secs</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>925</span><span class=o>:</span> <span class=o>[</span><span class=n>scrub</span> <span class=n>string</span> <span class=n>table</span><span class=o>,</span> <span class=n>0</span><span class=o>.</span><span class=na>0020253</span> <span class=n>secs</span><span class=o>]</span>
    <span class=o>[</span><span class=n>1</span> <span class=n>CMS</span><span class=o>-</span><span class=n>remark</span><span class=o>:</span> <span class=n>46556K</span><span class=o>(</span><span class=n>434176K</span><span class=o>)]</span> <span class=n>302804K</span><span class=o>(</span><span class=n>987136K</span><span class=o>),</span> <span class=n>0</span><span class=o>.</span><span class=na>2098574</span> <span class=n>secs</span><span class=o>]</span> 
    <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>44</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>10</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>21</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>27</span><span class=o>.</span><span class=na>930</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>sweep</span><span class=o>-</span><span class=n>start</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>961</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>sweep</span><span class=o>:</span> <span class=n>0</span><span class=o>.</span><span class=na>030</span><span class=o>/</span><span class=n>0</span><span class=o>.</span><span class=na>031</span> <span class=n>secs</span><span class=o>]</span> <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>15</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>02</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>03</span> <span class=n>secs</span><span class=o>]</span> 
<span class=n>27</span><span class=o>.</span><span class=na>961</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>reset</span><span class=o>-</span><span class=n>start</span><span class=o>]</span>
<span class=n>27</span><span class=o>.</span><span class=na>962</span><span class=o>:</span> <span class=o>[</span><span class=n>CMS</span><span class=o>-</span><span class=n>concurrent</span><span class=o>-</span><span class=n>reset</span><span class=o>:</span> <span class=n>0</span><span class=o>.</span><span class=na>001</span><span class=o>/</span><span class=n>0</span><span class=o>.</span><span class=na>001</span> <span class=n>secs</span><span class=o>]</span> <span class=o>[</span><span class=n>Times</span><span class=o>:</span> <span class=n>user</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>01</span> <span class=n>sys</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>00</span><span class=o>,</span> <span class=n>real</span><span class=o>=</span><span class=n>0</span><span class=o>.</span><span class=na>00</span> <span class=n>secs</span><span class=o>]</span> 
</code></pre></td></tr></table>
</div>
</div><p>Number of collections per 10 minutes:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/newSize_kolekcje.png data-srcset="/images/2020/05/newSize_kolekcje.png, /images/2020/05/newSize_kolekcje.png 1.5x, /images/2020/05/newSize_kolekcje.png 2x" data-sizes=auto alt=/images/2020/05/newSize_kolekcje.png title=/images/2020/05/newSize_kolekcje.png></p>
<p>Time spent in GC per minute:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/newSize_czas_gc.png data-srcset="/images/2020/05/newSize_czas_gc.png, /images/2020/05/newSize_czas_gc.png 1.5x, /images/2020/05/newSize_czas_gc.png 2x" data-sizes=auto alt=/images/2020/05/newSize_czas_gc.png title=/images/2020/05/newSize_czas_gc.png></p>
<p>Also, overall usage of the processor was reduced thanks to that changes (first change at 11:00 and second at 16:00):</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2020/05/wszystkie_zmiany_cpu.png data-srcset="/images/2020/05/wszystkie_zmiany_cpu.png, /images/2020/05/wszystkie_zmiany_cpu.png 1.5x, /images/2020/05/wszystkie_zmiany_cpu.png 2x" data-sizes=auto alt=/images/2020/05/wszystkie_zmiany_cpu.png title=/images/2020/05/wszystkie_zmiany_cpu.png></p>
<h3 id=summary>Summary</h3>
<p>To sum up, CMS does not have adaptive sizing policy and all changes to heap size are based only on free space after full GC.
Because of that, it is good practice to set not only max heap size by also min heap size, which should be based on how your application
allocates memory and how much does it need for normal functioning. Another thing you should be cautious about is how often
GC is being performed and how long does it take to clean heap form garbage. Moreover, I want to point out how important it is
to look at GC metrics, analyze <code>gc.log</code> from time to time, and adjust JVM tuning to your actual workload. All the tuning I did
to this JVM is fine right now but after a few months, application or traffic could change and we will end up with a poorly tuned
application.</p>
<h2 id=references>References</h2>
<p><a href=https://docs.oracle.com/javase/7/docs/technotes/guides/vm/gc-ergonomics.html target=_blank rel="noopener noreffer">GC ergonomics - Oracle docs</a></p>
<p><a href=https://www.jclarity.com/topics/products/censum/ target=_blank rel="noopener noreffer">jClarity Censum</a></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2023-02-21&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/788107276fce6591048daf6a7dec07cac52c0343 target=_blank title="commit by Marcin Skalski(marcin.skalski@konghq.com) 788107276fce6591048daf6a7dec07cac52c0343: move source code and add automation">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>7881072</a></span>
</div></div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/xms_good_practice/index.md target=_blank>Read Markdown</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://mskalski.dev/xms_good_practice/ data-title="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?" data-via=mskalski_><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://mskalski.dev/xms_good_practice/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://mskalski.dev/xms_good_practice/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://mskalski.dev/xms_good_practice/ data-title="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://mskalski.dev/xms_good_practice/ data-title="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://mskalski.dev/xms_good_practice/ data-title="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav><a href=/timeouts/ class=prev rel=prev title="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts</a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a>
</div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Marcin Skalski</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw" aria-hidden=true></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css><script type=text/javascript src=https://mskalski.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>