<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title>Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts - Marcin Skalski's Blog</title><meta name=Description content="Marcin Skalsi's personal blog about JVM internals, performance and other Java related stuff"><meta property="og:title" content="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts">
<meta property="og:description" content="So you have JVM based service (A) that is communicating with another service (B) using some kind of HTTP client. You know what you are doing so you gathered metrics statistics from your dependency. Especially it’s response times. Let’s assume that p99 of its response times form service B are 200ms. Also, this service is fairly close to you for example in the same data center. You adjusted your timeouts accordingly, for example, you’ve set connection timeout to 50ms and socket timeout to 250ms.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://mskalski.dev/timeouts/"><meta property="og:image" content="https://mskalski.dev/logo.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2019-12-13T07:45:47+01:00">
<meta property="article:modified_time" content="2023-02-21T07:05:40+01:00"><meta property="og:site_name" content="My cool site">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://mskalski.dev/logo.jpg">
<meta name=twitter:title content="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts">
<meta name=twitter:description content="So you have JVM based service (A) that is communicating with another service (B) using some kind of HTTP client. You know what you are doing so you gathered metrics statistics from your dependency. Especially it’s response times. Let’s assume that p99 of its response times form service B are 200ms. Also, this service is fairly close to you for example in the same data center. You adjusted your timeouts accordingly, for example, you’ve set connection timeout to 50ms and socket timeout to 250ms.">
<meta name=application-name content="Marcin Skalski's Blog">
<meta name=apple-mobile-web-app-title content="Marcin Skalski's Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://mskalski.dev/timeouts/><link rel=next href=https://mskalski.dev/xms_good_practice/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload="this.onload=null,this.rel='stylesheet'">
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mskalski.dev\/timeouts\/"},"image":["https:\/\/mskalski.dev\/images\/Apple-Devices-Preview.png"],"genre":"posts","wordcount":1792,"url":"https:\/\/mskalski.dev\/timeouts\/","datePublished":"2019-12-13T07:45:47+01:00","dateModified":"2023-02-21T07:05:40+01:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Marcin Skalski","logo":"https:\/\/mskalski.dev\/images\/avatar.png"},"author":{"@type":"Person","name":"Marcin Skalski"},"description":""}</script></head>
<body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':'dark'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'dark'==='dark')&&document.body.setAttribute('theme','dark')</script>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Marcin Skalski's Blog">Marcin Skalski's Blog</a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> Posts </a><a class=menu-item href=/public_speaking/> Public Speaking </a><a class=menu-item href=/about/> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Marcin Skalski's Blog">Marcin Skalski's Blog</a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search>
<i class="fas fa-search fa-fw" aria-hidden=true></i>
</a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear>
<i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span>
</div>
<a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>
Cancel
</a>
</div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/public_speaking/ title>Public Speaking</a><a class=menu-item href=/about/ title>About</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a></div>
</div>
</header><div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div><main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>Contents</h2>
<div class=toc-content id=toc-content-auto></div>
</div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts</h1><div class=post-meta>
<div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Marcin Skalski</a></span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-12-13>2019-12-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1792 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;9 minutes&nbsp;</div>
</div><div class="details toc" id=toc-static data-kept>
<div class="details-summary toc-title">
<span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li>
<ul>
<li><a href=#but-how-does-it-know-how-many-bytes-should-it-read>But how does it know how many bytes should it read?</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href=#references>References</a></li>
</ul>
</nav></div>
</div><div class=content id=content><p>So you have JVM based service (A) that is communicating with another service (B) using some kind of HTTP client.
You know what you are doing so you gathered metrics statistics from your dependency. Especially it’s response times.
Let’s assume that p99 of its response times form service B are 200ms. Also, this service is fairly close to you for example in the
same data center. You adjusted your timeouts accordingly, for example, you’ve set <code>connection timeout</code> to 50ms
and <code>socket timeout</code> to 250ms. Everything works fine but you are really thorough, have great
observability in your service and monitor metrics regularly. One day you noticed something:</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2019/12/grafana.png data-srcset="/images/2019/12/grafana.png, /images/2019/12/grafana.png 1.5x, /images/2019/12/grafana.png 2x" data-sizes=auto alt=/images/2019/12/grafana.png title=/images/2019/12/grafana.png></p>
<p>Wait, what? How is this even possible? You have set timeouts and in the
worst-case scenario, your requests should be timed out after 250ms.</p>
<p>Connection timeout restricts how long we will wait until the connection is established. So the result can be
either an open connection or unreachable host. So there shouldn’t be any problems. Let&rsquo;s take a look at socket timeout
maybe we can find something interesting.</p>
<h1 id=talk-is-cheap-show-me-the-code>&ldquo;Talk is cheap, show me the code&rdquo;</h1>
<p>To get a better understanding of whats going on we could write a simple socket server and simple client. All of the code was
written in java 11, on <code>AdoptOpenJDK 11.0.4</code></p>
<p>Here is the code of server:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Main</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span><span class=o>,</span> <span class=n>InterruptedException</span> <span class=o>{</span>
        <span class=c1>//starting server
</span><span class=c1></span>        <span class=k>try</span> <span class=o>(</span><span class=n>var</span> <span class=n>listener</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ServerSocket</span><span class=o>(</span><span class=n>59090</span><span class=o>))</span> <span class=o>{</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;The simple server is running...&#34;</span><span class=o>);</span>

            <span class=c1>//message to send
</span><span class=c1></span>            <span class=kt>byte</span><span class=o>[]</span> <span class=n>test</span> <span class=o>=</span> <span class=o>{</span><span class=n>1</span><span class=o>};</span>

            <span class=k>while</span> <span class=o>(</span><span class=kc>true</span><span class=o>)</span> <span class=o>{</span>
                <span class=k>try</span> <span class=o>(</span><span class=n>var</span> <span class=n>socket</span> <span class=o>=</span> <span class=n>listener</span><span class=o>.</span><span class=na>accept</span><span class=o>())</span> <span class=o>{</span>
                    <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Accepted connection&#34;</span><span class=o>);</span>
                    <span class=n>OutputStream</span> <span class=n>outputStream</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>();</span>
                    <span class=k>for</span> <span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>200</span><span class=o>;</span> <span class=n>i</span><span class=o>++)</span> <span class=o>{</span>
                        <span class=n>outputStream</span><span class=o>.</span><span class=na>write</span><span class=o>(</span><span class=n>test</span><span class=o>);</span>
                    <span class=o>}</span>
                    <span class=n>outputStream</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
                <span class=o>}</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>It is not rocket science, we are creating a new instance of <code>SocketServer</code> running on port <code>59090</code>. Next in line (9) we
prepare the message that we will send and it is a single byte, we will be sending it 200 times.
Next, we have an infinite loop that will wait for client connections and when this happens we will send
him our message.</p>
<p>Now, let&rsquo;s take a look at the client:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SimpleClient</span> <span class=o>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
        <span class=c1>//creating socket with timeout
</span><span class=c1></span>        <span class=n>var</span> <span class=n>socket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Socket</span><span class=o>(</span><span class=s>&#34;localhost&#34;</span><span class=o>,</span> <span class=n>59090</span><span class=o>);</span>
        <span class=n>socket</span><span class=o>.</span><span class=na>setSoTimeout</span><span class=o>(</span><span class=n>100</span><span class=o>);</span>

        <span class=c1>//byte array to store output
</span><span class=c1></span>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>b</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=o>];</span>

        <span class=kt>long</span> <span class=n>start</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>

        <span class=n>var</span> <span class=n>input</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=na>getInputStream</span><span class=o>();</span>
        <span class=n>var</span> <span class=n>read</span> <span class=o>=</span> <span class=n>input</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>b</span><span class=o>,</span> <span class=n>0</span><span class=o>,</span> <span class=n>300</span><span class=o>);</span>
        <span class=n>var</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span>
        <span class=k>while</span> <span class=o>(</span><span class=n>offset</span> <span class=o>&lt;=</span> <span class=n>200</span> <span class=o>&amp;&amp;</span> <span class=n>read</span> <span class=o>!=</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>offset</span> <span class=o>+=</span> <span class=n>read</span><span class=o>;</span>
            <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;read: &#34;</span> <span class=o>+</span> <span class=n>read</span> <span class=o>+</span> <span class=s>&#34;bytes&#34;</span><span class=o>);</span>
            <span class=n>read</span> <span class=o>=</span> <span class=n>input</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>b</span><span class=o>,</span> <span class=n>offset</span><span class=o>,</span> <span class=n>200</span><span class=o>);</span>
        <span class=o>}</span>

        <span class=kt>long</span> <span class=n>finish</span> <span class=o>=</span> <span class=n>System</span><span class=o>.</span><span class=na>currentTimeMillis</span><span class=o>();</span>
        <span class=kt>long</span> <span class=n>time</span> <span class=o>=</span> <span class=n>finish</span> <span class=o>-</span> <span class=n>start</span><span class=o>;</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Operation took: &#34;</span> <span class=o>+</span> <span class=n>time</span><span class=o>);</span>
        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;In total read &#34;</span> <span class=o>+</span> <span class=n>offset</span> <span class=o>+</span> <span class=s>&#34; bytes.&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>Not much to see here, we are creating new <code>Socket</code> instance that will connect to our localhost on port <code>59090</code> then we set
<code>soTimout</code> to <code>100ms</code> this is what we will be monitoring. Next, there is a prepared byte array to store the response from our
server. With everything prepared we can start reading. We know that we should read <code>200 bytes</code> so we will read until we
have collect 200 bytes and there is something to read. At the end to check if everything went well and we read the amount of
bytes that were expected we can print our reading offset.
(Function <code>InputStream.read(byte b[], int off, int len)</code> returns amount of bytes that were read).</p>
<p>Fantastic we have written some code so we can run it and measure how long it took to read the whole message.
I ran it a few times and got an average response of <code>17ms</code> and we have much time to spare until we reach the timeout.
Now lets see what happens when connection becomes slower. To simulate it we will add sleep in our server just after we
accept new connection:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=s>&#34;Accepted connection&#34;</span><span class=o>);</span>
<span class=n>sleep</span><span class=o>(</span><span class=n>150</span><span class=o>);</span>
<span class=n>OutputStream</span> <span class=n>outputStream</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=na>getOutputStream</span><span class=o>();</span>
</code></pre></td></tr></table>
</div>
</div><p>After running again our code we will get expected timeout exception :)</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=n>Exception</span> <span class=n>in</span> <span class=n>thread</span> <span class=s>&#34;main&#34;</span> <span class=n>java</span><span class=o>.</span><span class=na>net</span><span class=o>.</span><span class=na>SocketTimeoutException</span><span class=o>:</span> <span class=n>Read</span> <span class=n>timed</span> <span class=n>out</span>
	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>base</span><span class=o>/</span><span class=n>java</span><span class=o>.</span><span class=na>net</span><span class=o>.</span><span class=na>SocketInputStream</span><span class=o>.</span><span class=na>socketRead0</span><span class=o>(</span><span class=n>Native</span> <span class=n>Method</span><span class=o>)</span>
	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>base</span><span class=o>/</span><span class=n>java</span><span class=o>.</span><span class=na>net</span><span class=o>.</span><span class=na>SocketInputStream</span><span class=o>.</span><span class=na>socketRead</span><span class=o>(</span><span class=n>SocketInputStream</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>115</span><span class=o>)</span>
	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>base</span><span class=o>/</span><span class=n>java</span><span class=o>.</span><span class=na>net</span><span class=o>.</span><span class=na>SocketInputStream</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>SocketInputStream</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>168</span><span class=o>)</span>
	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>base</span><span class=o>/</span><span class=n>java</span><span class=o>.</span><span class=na>net</span><span class=o>.</span><span class=na>SocketInputStream</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>SocketInputStream</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>140</span><span class=o>)</span>
	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>skalski</span><span class=o>.</span><span class=na>SimpleClient</span><span class=o>.</span><span class=na>main</span><span class=o>(</span><span class=n>SimpleClient</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=n>17</span><span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><p>Everything works as expected. We can take a closer look right now what is going on inside of JDK code.
When we call <code>socket.setSoTimeout(100)</code>, this piece of code is executed:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setSoTimeout</span><span class=o>(</span><span class=kt>int</span> <span class=n>timeout</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SocketException</span> <span class=o>{</span>
       <span class=k>if</span> <span class=o>(</span><span class=n>isClosed</span><span class=o>())</span>
           <span class=k>throw</span> <span class=k>new</span> <span class=n>SocketException</span><span class=o>(</span><span class=s>&#34;Socket is closed&#34;</span><span class=o>);</span>
       <span class=k>if</span> <span class=o>(</span><span class=n>timeout</span> <span class=o>&lt;</span> <span class=n>0</span><span class=o>)</span>
         <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;timeout can&#39;t be negative&#34;</span><span class=o>);</span>

       <span class=n>getImpl</span><span class=o>().</span><span class=na>setOption</span><span class=o>(</span><span class=n>SocketOptions</span><span class=o>.</span><span class=na>SO_TIMEOUT</span><span class=o>,</span> <span class=n>timeout</span><span class=o>);</span>
   <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>As we can see in line (7) <code>SocketOptions.SO_TIMEOUT</code> option is set on our <code>java.net.SocketImpl</code> class.
In this scenario, <code>java.net.PlainSocketImpl</code> implementation of a socket is used. When we look at our client code in
line (13) we get <code>InputStream</code> form our socket and it is <code>java.net.SocketInputStream</code>. Next in line (19) we are calling
<code>read(byte b[], int off, int len)</code> method, underneath it is using written in C method <code>Java_java_net_SocketInputStream_socketRead0</code>
This method is long and you do not need to read it all. (But I encourage you to do it 😉) The important for us is part:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=k>if</span> <span class=p>(</span><span class=n>timeout</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>timeout</span> <span class=o>&lt;=</span> <span class=mi>5000</span> <span class=o>||</span> <span class=o>!</span><span class=n>isRcvTimeoutSupported</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>NET_Timeout</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>timeout</span><span class=p>);</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>JNU_ThrowByName</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;java/net/SocketTimeoutException&#34;</span><span class=p>,</span>
                                <span class=s>&#34;Read timed out&#34;</span><span class=p>);</span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>ret</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>JNU_ThrowByName</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;java/net/SocketException&#34;</span><span class=p>,</span> <span class=s>&#34;socket closed&#34;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>bufP</span> <span class=o>!=</span> <span class=n>BUF</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>free</span><span class=p>(</span><span class=n>bufP</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=cm>/*check if the socket has been closed while we were in timeout*/</span>
        <span class=n>newfd</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>GetIntField</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>fdObj</span><span class=p>,</span> <span class=n>IO_fd_fdID</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>newfd</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>JNU_ThrowByName</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=s>&#34;java/net/SocketException&#34;</span><span class=p>,</span> <span class=s>&#34;Socket closed&#34;</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>bufP</span> <span class=o>!=</span> <span class=n>BUF</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>free</span><span class=p>(</span><span class=n>bufP</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>In the line (3) <code>NET_Timeout</code> function is called, when we look inside it we can see that it is calling operating system
polling function that waits for events on file descriptor, in Linux it is <code>poll(2)</code> in BSD <code>select(2)</code> and <code>select(4)</code> in Windows.
For all of those functions timeout that we specified earlier is passed. Those polling functions will wait without blocking
until the end of our timeout or for events on file descriptors to occur. They return how many descriptors registered some events.
In next steps errors are handled and <code>SocketTimeoutException</code> is thrown if polling function returned <code>-1</code> which means it
timed out. If everything went well this piece of code is executed:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>nread</span> <span class=o>=</span> <span class=n>recv</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>bufP</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<span class=k>if</span> <span class=p>(</span><span class=n>nread</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>SetByteArrayRegion</span><span class=p>(</span><span class=n>env</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>off</span><span class=p>,</span> <span class=n>nread</span><span class=p>,</span> <span class=p>(</span><span class=n>jbyte</span> <span class=o>*</span><span class=p>)</span><span class=n>bufP</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>In line (1) <code>recv</code> function is called it is used to read bytes from the socket, then these bytes are populated to byte array
we have passed to <code>InputStream.read</code> function and number of read bytes is returned.</p>
<h1 id=returning-to-our-simple-client>Returning to our simple client</h1>
<p>So we know how socket timeout work, it is pretty simple and it does what most of us probably thought it do.
But it still did not explain why some of the requests to service B took more than timeout, so let&rsquo;s dig deeper.</p>
<p>What happens when we put our sleep just after sending the first byte?
In our logs, we can see that we have read a single byte and then we got <code>SocketTimeoutException</code>, so our client read the first
part of the message and then encountered a problem. But it was expected because the server took much longer to respond
than we thought it will. I think we can test at least one more thing, we can play with our sleep time. Lets set it to <code>50ms</code>
and run our code. Here is the result of execution:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Operation took: 10490
In total read 200 bytes.
</code></pre></td></tr></table>
</div>
</div><p>Whaat? <code>Operation took: 10490</code> how is that even possible? We set <code>socketTimeout</code> to <code>100ms</code> and our connection took
more than 10 seconds. Maybe there is some bug? Let&rsquo;s run it again:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>Operation took: 10509
In total read 200 bytes.
</code></pre></td></tr></table>
</div>
</div><p>Almost the same result. Can it be our original problem? Yes it is! It is almost exactly how <code>OkHttpClient</code> works. Here is
code sample from this library:</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=kd>private</span> <span class=kt>void</span> <span class=nf>readFrom</span><span class=o>(</span><span class=n>InputStream</span> <span class=n>in</span><span class=o>,</span> <span class=kt>long</span> <span class=n>byteCount</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>forever</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=o>{</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>in</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;in == null&#34;</span><span class=o>);</span>
    <span class=k>while</span> <span class=o>(</span><span class=n>byteCount</span> <span class=o>&gt;</span> <span class=n>0</span> <span class=o>||</span> <span class=n>forever</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>Segment</span> <span class=n>tail</span> <span class=o>=</span> <span class=n>writableSegment</span><span class=o>(</span><span class=n>1</span><span class=o>);</span>
      <span class=kt>int</span> <span class=n>maxToCopy</span> <span class=o>=</span> <span class=o>(</span><span class=kt>int</span><span class=o>)</span> <span class=n>Math</span><span class=o>.</span><span class=na>min</span><span class=o>(</span><span class=n>byteCount</span><span class=o>,</span> <span class=n>Segment</span><span class=o>.</span><span class=na>SIZE</span> <span class=o>-</span> <span class=n>tail</span><span class=o>.</span><span class=na>limit</span><span class=o>);</span>
      <span class=kt>int</span> <span class=n>bytesRead</span> <span class=o>=</span> <span class=n>in</span><span class=o>.</span><span class=na>read</span><span class=o>(</span><span class=n>tail</span><span class=o>.</span><span class=na>data</span><span class=o>,</span> <span class=n>tail</span><span class=o>.</span><span class=na>limit</span><span class=o>,</span> <span class=n>maxToCopy</span><span class=o>);</span>
      <span class=k>if</span> <span class=o>(</span><span class=n>bytesRead</span> <span class=o>==</span> <span class=o>-</span><span class=n>1</span><span class=o>)</span> <span class=o>{</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>forever</span><span class=o>)</span> <span class=k>return</span><span class=o>;</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>EOFException</span><span class=o>();</span>
      <span class=o>}</span>
      <span class=n>tail</span><span class=o>.</span><span class=na>limit</span> <span class=o>+=</span> <span class=n>bytesRead</span><span class=o>;</span>
      <span class=n>size</span> <span class=o>+=</span> <span class=n>bytesRead</span><span class=o>;</span>
      <span class=n>byteCount</span> <span class=o>-=</span> <span class=n>bytesRead</span><span class=o>;</span>
    <span class=o>}</span>
  <span class=o>}</span>
</code></pre></td></tr></table>
</div>
</div><p>This client have to read the expected amount of data and will read in parts until whole message was send, so even if
single byte was send via socket before timeout elapsed <code>SocketTimeoutException</code> will not be thrown.</p>
<h3 id=but-how-does-it-know-how-many-bytes-should-it-read>But how does it know how many bytes should it read?</h3>
<p>The answer to this question is actually pretty simple. <code>HTTP</code> response has a predefined scheme. First of all, we have <code>Status line</code>
which contains status code, next we have <code>headers</code> and finally <code>message body</code>. Headers and body are separated with <code>CRLF</code>
Also one of the headers is <code>Content-Length</code> which indicates how long message body will be. So while receiving response
from another service via <code>HTTP/1.1</code> we can calculate when to stop reading from the socket after receiving an appropriate amount
of bytes.</p>
<p><img class=lazyload src=/svg/loading.min.svg data-src=/images/2019/12/HTTP_Response.png data-srcset="/images/2019/12/HTTP_Response.png, /images/2019/12/HTTP_Response.png 1.5x, /images/2019/12/HTTP_Response.png 2x" data-sizes=auto alt=/images/2019/12/HTTP_Response.png title="Http protocol"></p>
<h1 id=summing-up>Summing up</h1>
<p>After reading this short article you should know how timeouts work inside of <code>JDK</code> and why your request to another service
took longer than expected. The Most important piece of knowledge you should remember is that when you set <code>socketTimeout</code> for
example on <code>RestTemplate</code> while using Spring you set a timeout for every single read form socket which effectively becomes
time from last bit of information after your connection will be interrupted. You should keep it in mind when you set timeouts
next time in your application and adjust them accordingly. Fortunately since <code>3.12.0</code> version of <code>OkHttp</code> client you can specify
call timeout <code>OkHttpClient.Builder.callTimeout()</code> which will limit whole operation time.</p>
<p>That all from me, thank you all for reading my first post. Feel free to let me know how you liked it, also I encourage
you to comment, ask questions and share the knowledge with your coworkers.</p>
<h2 id=references>References</h2>
<p><a href=https://github.com/Automaat/extended_timeouts target=_blank rel="noopener noreffer">Source code of examples used in this post</a></p>
<p><a href=https://github.com/square/okhttp/ target=_blank rel="noopener noreffer">OkHttp</a></p>
<p><a href=https://hg.openjdk.java.net/jdk/jdk target=_blank rel="noopener noreffer">JDK</a></p>
</div><div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>Updated on 2023-02-21&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/788107276fce6591048daf6a7dec07cac52c0343 target=_blank title="commit by Marcin Skalski(marcin.skalski@konghq.com) 788107276fce6591048daf6a7dec07cac52c0343: move source code and add automation">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>7881072</a></span>
</div></div>
<div class=post-info-line>
<div class=post-info-md><span>
<a class=link-to-markdown href=/timeouts/index.md target=_blank>Read Markdown</a>
</span></div>
<div class=post-info-share>
<span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://mskalski.dev/timeouts/ data-title="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts" data-via=mskalski_><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://mskalski.dev/timeouts/><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://mskalski.dev/timeouts/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://mskalski.dev/timeouts/ data-title="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Line" data-sharer=line data-url=https://mskalski.dev/timeouts/ data-title="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="Share on 微博" data-sharer=weibo data-url=https://mskalski.dev/timeouts/ data-title="Why my HTTP request did not timed out? Quick tour inside JDK and OkHttpClient for better understanding of timeouts"><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span>
</section>
</div>
<div class=post-nav>
<a href=/xms_good_practice/ class=next rel=next title="Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?">Why is it good practice to set -Xms along -Xmx java flag while using Concurrent Mark Sweep (CMS) collector?<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div>
</div>
<div id=comments><div id=disqus_thread class=comment></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://disqus.com/?ref_noscript>Disqus</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.91.2">Hugo</a> | Theme - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a>
</div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Marcin Skalski</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div>
</div>
</footer></div>
<div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top">
<i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments">
<i class="fas fa-comment fa-fw" aria-hidden=true></i>
</a>
</div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css><script type=text/javascript src=https://mskalski.disqus.com/embed.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.13.1/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{},cookieconsent:{content:{dismiss:"Got it!",link:"Learn more",message:"This website uses Cookies to improve your experience."},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},search:{algoliaAppID:"PASDMWALPK",algoliaIndex:"index.en",algoliaSearchKey:"b42948e51daaa93df92381c8e2ac0f93",highlightTag:"em",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"algolia"}}</script><script type=text/javascript src=/js/theme.min.js></script></body>
</html>